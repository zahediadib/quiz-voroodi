<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قرعه‌کشی بزرگ - Grand Lucky Draw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #050505;
            color: #ffffff;
            font-family: 'Vazirmatn', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* Neon Glow Effects */
        .neon-text {
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.7), 0 0 20px rgba(6, 182, 212, 0.5);
        }

        .neon-box {
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3), inset 0 0 15px rgba(139, 92, 246, 0.1);
            border: 2px solid rgba(139, 92, 246, 0.5);
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(5px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .neon-box.active {
            border-color: #22d3ee;
            box-shadow: 0 0 25px rgba(34, 211, 238, 0.6), inset 0 0 20px rgba(34, 211, 238, 0.2);
            transform: scale(1.1);
            z-index: 10;
        }

        .neon-box.locked-0 {
            border-color: #ef4444; /* Red for 0 */
            color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        .neon-box.locked-1 {
            border-color: #10b981; /* Green for 1 */
            color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        /* Retro Font for Numbers */
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        /* Floating Animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .float-anim { animation: float 4s ease-in-out infinite; }

        /* Glitch Effect Keyframes */
        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
        .glitch-active { animation: glitch 0.2s infinite; }

        /* Winner Modal */
        #winner-overlay {
            background: radial-gradient(circle, rgba(23, 37, 84, 0.95) 0%, rgba(0,0,0,0.98) 100%);
        }

        /* Start Button Overlay */
        #start-overlay {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center relative">

<!-- Dynamic Background Canvas -->
<canvas id="bgCanvas" class="absolute inset-0 z-0"></canvas>

<!-- Start Overlay (Required for Audio Context) -->
<div id="start-overlay" class="fixed inset-0 flex items-center justify-center flex-col transition-opacity duration-500">
    <button onclick="startGameSystem()" class="group relative px-8 py-4 bg-transparent overflow-hidden rounded-lg">
        <span class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-cyan-500 to-purple-500 opacity-20 group-hover:opacity-40 transition-opacity"></span>
        <span class="absolute top-0 left-0 w-full h-full border border-cyan-500 rounded-lg shadow-[0_0_15px_rgba(6,182,212,0.5)] animate-pulse"></span>
        <span class="relative text-2xl font-bold text-cyan-300 tracking-widest uppercase">
                فعال‌سازی سیستم
            </span>
        <p class="text-xs text-gray-400 mt-2 font-mono">SYSTEM INITIALIZATION</p>
    </button>
</div>

<!-- Main Content -->
<div class="relative z-10 w-full max-w-6xl px-4 flex flex-col items-center gap-12 transition-opacity duration-1000 opacity-50" id="main-content">

    <!-- Header -->
    <header class="text-center float-anim">
        <h1 class="text-5xl md:text-7xl font-black mb-4 bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 drop-shadow-lg">
            قرعه‌کشی جشن ورودی ۰۴
        </h1>
    </header>

    <!-- Bit Display Grid -->
    <div class="flex flex-row-reverse gap-2 md:gap-4 lg:gap-6 justify-center w-full perspective-1000">
        <div id="bits-container" class="flex gap-3 md:gap-6" dir="ltr">
            <!-- Javascript will fill this -->
        </div>
    </div>

    <!-- Instructions -->
    <div class="mt-8 text-center space-y-2" style="display: none !important;">
        <div class="inline-block px-6 py-3 rounded-full border border-cyan-500/30 bg-cyan-900/20 backdrop-blur-md">
            <p class="text-cyan-300 text-lg animate-pulse">
                برای نمایش بیت بعدی <span class="font-bold border-b-2 border-cyan-400 mx-1">ENTER</span> را بزنید
            </p>
        </div>
        <p class="text-xs text-gray-600 mt-2">برای شروع مجدد R را بزنید</p>
    </div>
</div>

<!-- Winner Overlay (Hidden by default) -->
<div id="winner-overlay" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-1000 transform scale-110">
    <div class="text-center relative">
        <h2 class="text-4xl md:text-6xl text-purple-300 font-bold mb-6 animate-bounce">برنده خوش‌شانس</h2>
        <div class="relative group">
            <div class="absolute -inset-1 bg-gradient-to-r from-pink-600 to-purple-600 rounded-lg blur opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200 animate-pulse"></div>
            <div class="relative bg-black rounded-lg p-10 md:p-16 border-2 border-purple-500">
                    <span id="decimal-result" class="pixel-font text-8xl md:text-9xl text-transparent bg-clip-text bg-gradient-to-br from-yellow-300 via-orange-400 to-red-500 filter drop-shadow-[0_0_15px_rgba(234,179,8,0.5)]">
                        0
                    </span>
            </div>
        </div>
        <p class="mt-8 text-xl text-gray-300 font-light">عدد نهایی</p>
        <button onclick="resetGame()" class="mt-10 px-8 py-2 bg-white/10 hover:bg-white/20 rounded border border-white/20 transition">شروع مجدد</button>
    </div>
</div>

<script>
    // --- Sound Engine (Web Audio API) ---
    class SoundManager {
        constructor() {
            this.ctx = null;
            this.ambienceNodes = [];
            this.isMuted = false;
        }

        init() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            this.startAmbience();
        }

        // Create a low throbbing drone for "Waiting"
        startAmbience() {
            if (!this.ctx) return;

            // Stop previous if exists
            this.stopAmbience();

            // Oscillator 1: Deep Bass
            const osc1 = this.ctx.createOscillator();
            osc1.type = 'sawtooth';
            osc1.frequency.value = 50;

            // Filter for "muffled" underwater sound
            const filter = this.ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 200;

            // LFO to modulate filter (Throbbing effect)
            const lfo = this.ctx.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.value = 0.2; // Slow pulse
            const lfoGain = this.ctx.createGain();
            lfoGain.gain.value = 100; // Modulation depth

            const masterGain = this.ctx.createGain();
            masterGain.gain.value = 0.15; // Low volume

            // Connections
            lfo.connect(lfoGain);
            lfoGain.connect(filter.frequency);
            osc1.connect(filter);
            filter.connect(masterGain);
            masterGain.connect(this.ctx.destination);

            osc1.start();
            lfo.start();

            this.ambienceNodes = [osc1, lfo, lfoGain, masterGain, filter];
        }

        stopAmbience() {
            this.ambienceNodes.forEach(node => {
                if(node.stop) node.stop();
                node.disconnect();
            });
            this.ambienceNodes = [];
        }

        // High-tech scrambling sound
        playScramble() {
            if (!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();

            osc.type = 'square';
            // Randomize frequency rapidly
            osc.frequency.setValueAtTime(800, this.ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(2000, this.ctx.currentTime + 0.1);

            gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);

            osc.connect(gain);
            gain.connect(this.ctx.destination);

            osc.start();
            osc.stop(this.ctx.currentTime + 0.1);
        }

        // Heavy impact lock sound
        playLock(isOne) {
            if (!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();

            osc.type = isOne ? 'triangle' : 'sine';
            // Pitch drop for impact
            osc.frequency.setValueAtTime(isOne ? 400 : 200, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, this.ctx.currentTime + 0.3);

            gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);

            osc.connect(gain);
            gain.connect(this.ctx.destination);

            osc.start();
            osc.stop(this.ctx.currentTime + 0.3);
        }

        // Euphoric chord for winning
        playWin() {
            if (!this.ctx) return;

            // Major Chord Frequencies (C4, E4, G4, C5)
            const freqs = [261.63, 329.63, 392.00, 523.25];

            freqs.forEach((freq, i) => {
                setTimeout(() => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();

                    osc.type = 'triangle';
                    osc.frequency.value = freq;

                    gain.gain.setValueAtTime(0, this.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.1, this.ctx.currentTime + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 2);

                    osc.connect(gain);
                    gain.connect(this.ctx.destination);

                    osc.start();
                    osc.stop(this.ctx.currentTime + 2);
                }, i * 100); // Stagger notes
            });
        }
    }

    const soundManager = new SoundManager();

    function startGameSystem() {
        const overlay = document.getElementById('start-overlay');
        const main = document.getElementById('main-content');

        soundManager.init();

        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 500);

        main.style.opacity = '1';
    }

    // --- Game Logic ---
    const totalBits = 8;
    let currentBitIndex = 0;
    let bits = new Array(totalBits).fill(null);
    let isAnimating = false;
    let isGameOver = false;

    const container = document.getElementById('bits-container');

    function initBoard() {
        container.innerHTML = '';
        for (let i = 0; i < totalBits; i++) {
            const box = document.createElement('div');
            box.id = `bit-${i}`;
            box.className = `neon-box w-12 h-16 md:w-20 md:h-28 flex items-center justify-center rounded-lg text-3xl md:text-5xl font-bold pixel-font text-gray-600`;
            box.innerText = '?';

            const label = document.createElement('div');
            label.className = "absolute -bottom-8 text-xs text-gray-500 font-sans opacity-50";
            label.innerText = Math.pow(2, totalBits - 1 - i);

            const wrapper = document.createElement('div');
            wrapper.className = "relative flex flex-col items-center";
            wrapper.appendChild(box);
            wrapper.appendChild(label);

            container.appendChild(wrapper);
        }
    }

    function resetGame() {
        currentBitIndex = 0;
        bits = new Array(totalBits).fill(null);
        isGameOver = false;
        isAnimating = false;

        const overlay = document.getElementById('winner-overlay');
        overlay.classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
        overlay.classList.add('opacity-0', 'pointer-events-none', 'scale-110');

        // Resume Ambience if stopped
        soundManager.startAmbience();

        initBoard();
    }

    function revealNextBit() {
        if (isGameOver || isAnimating) return;
        if (currentBitIndex >= totalBits) return;

        isAnimating = true;
        const bitElement = document.getElementById(`bit-${currentBitIndex}`);
        bitElement.classList.add('active', 'glitch-active');
        bitElement.classList.remove('text-gray-600');
        bitElement.classList.add('text-white');

        let decodes = 0;
        const maxDecodes = 15;

        const interval = setInterval(() => {
            bitElement.innerText = Math.random() > 0.5 ? '1' : '0';
            soundManager.playScramble(); // SFX per flip
            decodes++;

            if (decodes > maxDecodes) {
                clearInterval(interval);
                finalizeBit(bitElement);
            }
        }, 60);
    }

    function finalizeBit(element) {
        const finalValue = Math.random() > 0.5 ? 1 : 0;
        bits[currentBitIndex] = finalValue;

        element.innerText = finalValue;
        element.classList.remove('active', 'glitch-active', 'text-white');

        // SFX Lock
        soundManager.playLock(finalValue === 1);

        if (finalValue === 1) {
            element.classList.add('locked-1');
        } else {
            element.classList.add('locked-0');
        }

        isAnimating = false;
        currentBitIndex++;

        if (currentBitIndex === totalBits) {
            setTimeout(showWinner, 500);
        }
    }

    function showWinner() {
        isGameOver = true;
        const binaryString = bits.join('');
        const decimalValue = parseInt(binaryString, 2);

        document.getElementById('decimal-result').innerText = decimalValue;

        const overlay = document.getElementById('winner-overlay');
        overlay.classList.remove('opacity-0', 'pointer-events-none', 'scale-110');
        overlay.classList.add('opacity-100', 'pointer-events-auto', 'scale-100');

        // Stop ambience and play Win sound
        soundManager.stopAmbience();
        soundManager.playWin();

        fireConfetti();
    }

    // --- Event Listeners ---
    document.addEventListener('keydown', (e) => {
        // Prevent accidental triggers if start overlay is still up
        if (document.getElementById('start-overlay') && document.getElementById('start-overlay').style.opacity !== '0') return;

        if (e.key === 'Enter') {
            revealNextBit();
        }
        if (e.key.toLowerCase() === 'r') {
            resetGame();
        }
    });

    // --- Visual Effects (Canvas) ---
    const canvas = document.getElementById('bgCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 2;
            this.speedX = (Math.random() - 0.5) * 0.5;
            this.speedY = (Math.random() - 0.5) * 0.5;
            this.color = Math.random() > 0.5 ? 'rgba(6, 182, 212, ' : 'rgba(139, 92, 246, ';
            this.opacity = Math.random() * 0.5;
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            if (this.x > canvas.width) this.x = 0;
            if (this.x < 0) this.x = canvas.width;
            if (this.y > canvas.height) this.y = 0;
            if (this.y < 0) this.y = canvas.height;
        }
        draw() {
            ctx.fillStyle = this.color + this.opacity + ')';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    for (let i = 0; i < 100; i++) particles.push(new Particle());

    let confettiParticles = [];
    function fireConfetti() {
        for (let i = 0; i < 150; i++) {
            confettiParticles.push({
                x: canvas.width / 2,
                y: canvas.height / 2,
                vx: (Math.random() - 0.5) * 20,
                vy: (Math.random() - 0.5) * 20,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                life: 100
            });
        }
    }

    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        particles.forEach(p => {
            p.update();
            p.draw();
        });

        for (let i = confettiParticles.length - 1; i >= 0; i--) {
            let p = confettiParticles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.2;
            p.life--;

            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 8, 8);

            if (p.life <= 0) confettiParticles.splice(i, 1);
        }

        ctx.strokeStyle = 'rgba(255,255,255,0.05)';
        ctx.lineWidth = 1;
        for (let i = 0; i < particles.length; i++) {
            for (let j = i; j < particles.length; j++) {
                const dx = particles[i].x - particles[j].x;
                const dy = particles[i].y - particles[j].y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < 100) {
                    ctx.beginPath();
                    ctx.moveTo(particles[i].x, particles[i].y);
                    ctx.lineTo(particles[j].x, particles[j].y);
                    ctx.stroke();
                }
            }
        }

        requestAnimationFrame(animate);
    }

    initBoard();
    animate();

</script>
</body>
</html>