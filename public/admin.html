<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/sahel-font@v3.4.0/dist/font-face.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap');
        body { font-family: 'Sahel', sans-serif; }

        .smooth-width { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .smooth-color { transition: background-color 0.3s ease, color 0.3s ease; }
        .smooth-fade { transition: opacity 0.3s ease; }

        #adm-timer { font-variant-numeric: tabular-nums; min-width: 80px; display: inline-block; text-align: left; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col p-4" onclick="closeDropdowns(event)">

<div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded shadow-lg text-center">
        <h2 class="text-xl font-bold mb-4">رمز عبور ادمین</h2>
        <input type="password" id="admin-pass" class="border p-2 rounded w-full mb-2">
        <button onclick="auth()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">ورود</button>
    </div>
</div>

<div id="admin-interface" class="hidden flex-col h-full">
    <div class="bg-white p-3 rounded shadow mb-2 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-bold">پنل مدیریت</h1>
            <span id="adm-phase-badge" class="px-2 py-1 bg-gray-200 rounded text-xs font-mono smooth-color">PHASE</span>
            <span class="text-xs text-gray-400 font-mono" id="connection-status">Online</span>
        </div>
        <div class="flex gap-2">
            <div class="relative">
                <button id="btn-revive-menu" onclick="toggleReviveMenu(event)" class="bg-pink-600 text-white px-3 py-1 rounded text-sm hover:bg-pink-700">
                    <i class="fa-solid fa-heart-pulse mr-1"></i> ریوایو
                </button>
                <div id="revive-dropdown" class="absolute left-0 top-full mt-1 bg-white border shadow-lg rounded hidden w-56 z-50">
                    <button onclick="reviveAll()" class="block w-full text-right px-4 py-2 hover:bg-gray-100 text-sm"><i class="fa-solid fa-users-medical ml-2 text-gray-500"></i>ریوایو همه مردگان</button>
                    <button onclick="reviveRound()" class="block w-full text-right px-4 py-2 hover:bg-gray-100 text-sm"><i class="fa-solid fa-clock-rotate-left ml-2 text-gray-500"></i>ریوایو حذف شدگان اخیر</button>
                </div>
            </div>
            <button id="btn-toggle-presenter" onclick="togglePresenterList()" class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 w-40">
                <i class="fa-solid fa-gamepad mr-1"></i> نمایش: بازی
            </button>
            <button onclick="resetEverything()" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i> ریست کلی
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 flex-grow overflow-hidden">
        <div class="md:col-span-5 flex flex-col gap-2 overflow-hidden h-full">
            <div class="bg-blue-50 p-4 rounded border shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold"><i class="fa-regular fa-clock ml-1"></i>تایمر</span>
                    <span class="text-3xl font-bold text-blue-600 font-mono" id="adm-timer">0.0</span>
                </div>
                <div class="flex gap-2 items-center">
                    <select id="adm-q-select" class="flex-grow border rounded p-2 text-sm h-10"></select>
                    <select id="adm-time-select" class="border rounded p-2 text-sm h-10 w-20 text-center font-bold">
                        <option value="10">10s</option>
                        <option value="15">15s</option>
                        <option value="20">20s</option>
                        <option value="30" selected>30s</option>
                    </select>
                    <button onclick="adminStartSelected()" class="bg-green-600 text-white w-12 h-10 rounded hover:bg-green-700 flex items-center justify-center">
                        <i class="fa-solid fa-play"></i>
                    </button>
                </div>
                <button id="btn-end-q" onclick="socket.emit('admin_command', {action:'END_QUESTION_NOW'})" class="hidden w-full bg-orange-500 text-white py-2 rounded font-bold mt-2 hover:bg-orange-600 smooth-fade">
                    <i class="fa-solid fa-stop mr-1"></i> پایان سوال (Force Stop)
                </button>
            </div>

            <div class="bg-white p-4 rounded border flex-grow overflow-y-auto relative">
                <h3 class="text-gray-500 text-sm mb-2 border-b"><i class="fa-solid fa-eye ml-1"></i>پیش‌نمایش و آمار:</h3>
                <p id="adm-prev-text" class="font-bold mb-4 text-lg">...</p>
                <div id="adm-prev-opts" class="space-y-2 text-sm"></div>
            </div>
        </div>

        <div class="md:col-span-7 bg-white rounded border flex flex-col h-full overflow-hidden">
            <div class="p-2 border-b bg-gray-50 grid grid-cols-4 gap-2 text-center text-xs" id="adm-stats-bar"></div>
            <div class="p-3 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <h2 class="font-bold"><i class="fa-solid fa-users ml-1"></i>شرکت کنندگان</h2>
                <div class="flex gap-2">
                    <span class="bg-gray-200 text-gray-800 px-2 rounded text-sm" title="Total">کل: <span id="adm-total-count">0</span></span>
                    <span class="bg-blue-100 text-blue-800 px-2 rounded text-sm" title="Alive">زنده: <span id="adm-alive-count">0</span></span>
                </div>
            </div>
            <div class="overflow-y-auto flex-grow p-2">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-white shadow-sm z-10">
                    <tr class="text-right border-b text-gray-500 bg-gray-50"><th class="pb-2">نام</th><th>ID</th><th>پاسخ</th><th>وضعیت</th><th>عملیات</th></tr>
                    </thead>
                    <tbody id="adm-player-list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io({transports: ['websocket']});
    let allQuestions = [];
    let currentPresenterMode = 'GAME';
    let savedQuestionStats = {};
    let timerFrame = null;

    socket.on('connect', () => {
        document.getElementById('connection-status').innerText = 'Connected';
        document.getElementById('connection-status').className = 'text-xs text-green-600 font-mono';
        const savedPass = localStorage.getItem('admin_pass');
        if(savedPass) {
            document.getElementById('admin-pass').value = savedPass;
            auth();
        }
    });

    socket.on('disconnect', () => {
        document.getElementById('connection-status').innerText = 'Disconnected';
        document.getElementById('connection-status').className = 'text-xs text-red-600 font-mono';
    });

    function auth() { const pass = document.getElementById('admin-pass').value; if(!pass) return; socket.emit('admin_auth', pass); }

    socket.on('admin_auth_success', () => {
        localStorage.setItem('admin_pass', document.getElementById('admin-pass').value);
        document.getElementById('auth-modal').classList.add('hidden');
        document.getElementById('admin-interface').classList.remove('hidden');
        document.getElementById('admin-interface').classList.add('flex');
        socket.emit('request_admin_data');
    });

    socket.on('admin_auth_fail', () => { document.getElementById('auth-modal').classList.remove('hidden'); alert('رمز اشتباه است'); });

    // --- SMOOTH TIMER (FIXED FOR TABLET) ---
    function runSmoothTimer(seconds) {
        if(timerFrame) cancelAnimationFrame(timerFrame);
        const endTime = Date.now() + (seconds * 1000);
        function step() {
            const now = Date.now();
            const remain = Math.max(0, (endTime - now) / 1000);
            document.getElementById('adm-timer').innerText = remain.toFixed(1);
            if (remain > 0) {
                timerFrame = requestAnimationFrame(step);
            } else {
                document.getElementById('adm-timer').innerText = "0.0";
            }
        }
        step();
    }

    // --- PULSE (With Tablet Jitter Fix) ---
    socket.on('sync_pulse', (data) => {
        if (data.phase === 'QUESTION') {
            const serverTime = parseFloat(data.time);
            const currentDisplay = parseFloat(document.getElementById('adm-timer').innerText);

            // INCREASED TOLERANCE TO 2.5s:
            // This prevents "jumping" on WiFi tablets unless the difference is huge.
            if (!timerFrame || Math.abs(currentDisplay - serverTime) > 2.5) {
                runSmoothTimer(serverTime);
            }
        } else {
            if(timerFrame) cancelAnimationFrame(timerFrame);
            timerFrame = null;
            document.getElementById('adm-timer').innerText = data.time;
        }
        document.getElementById('adm-phase-badge').innerText = data.phase;
    });

    // --- HEAVY DATA UPDATE ---
    socket.on('admin_data', (data) => {
        currentPresenterMode = data.gameState.presenterMode;
        savedQuestionStats = data.gameState.questionStats || {};

        const totalCountEl = document.getElementById('adm-total-count');
        if(totalCountEl) totalCountEl.innerText = Object.keys(data.players).length;

        // This will now update correctly after Revive
        const aliveCountEl = document.getElementById('adm-alive-count');
        if(aliveCountEl) aliveCountEl.innerText = data.gameState.aliveCount;

        const pBtn = document.getElementById('btn-toggle-presenter');
        if (pBtn) {
            if (currentPresenterMode === 'GAME') {
                pBtn.innerHTML = '<i class="fa-solid fa-gamepad mr-1"></i> نمایش: بازی';
                pBtn.className = "bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 w-40 smooth-color";
            } else {
                pBtn.innerHTML = '<i class="fa-solid fa-list-ol mr-1"></i> نمایش: لیست';
                pBtn.className = "bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 w-40 smooth-color";
            }
        }

        const list = document.getElementById('adm-player-list');
        const stats = [0,0,0,0];
        let totalAnswers = 0;
        const currentQIdx = data.gameState.currentQuestionIndex;

        const playersArr = Object.values(data.players);
        playersArr.sort((a, b) => {
            if (a.isAlive === b.isAlive) return a.name.localeCompare(b.name);
            return b.isAlive ? 1 : -1;
        });

        const existingRows = new Map();
        list.querySelectorAll('tr').forEach(tr => {
            if(tr.id) existingRows.set(tr.id, tr);
        });

        const newRowsFragment = document.createDocumentFragment();

        playersArr.forEach(p => {
            const rowId = `row-${p.studentId}`;
            const showAnswer = (p.isAlive || p.deathRound === currentQIdx) && p.currentAnswer !== null;
            if(showAnswer) { stats[p.currentAnswer]++; totalAnswers++; }

            const statusClass = p.isAlive ? 'text-green-700' : 'text-red-700';
            const bgClass = p.isAlive ? 'bg-green-50' : 'bg-red-50 text-gray-400';
            const statusText = p.isAlive ? 'زنده' : 'حذف';

            let ansDisplay = '-';
            if(showAnswer) ansDisplay = `<span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded font-bold">${parseInt(p.currentAnswer)+1}</span>`;

            let row = existingRows.get(rowId);

            if (row && !row.querySelector('.name-cell')) {
                row.remove();
                row = null;
            }

            if (!row) {
                row = document.createElement('tr');
                row.id = rowId;
                row.innerHTML = `
                    <td class="p-2 border-b name-cell"></td>
                    <td class="p-2 border-b font-mono text-xs id-cell"></td>
                    <td class="p-2 border-b ans-cell"></td>
                    <td class="p-2 border-b font-bold status-cell"></td>
                    <td class="p-2 border-b">
                        <button onclick="kick('${p.studentId}')" class="text-red-500 mx-1"><i class="fa-solid fa-trash-can"></i></button>
                        <button onclick="reviveOne('${p.studentId}')" class="text-pink-500 mx-1"><i class="fa-solid fa-heart-pulse"></i></button>
                    </td>`;
            }

            existingRows.delete(rowId);
            newRowsFragment.appendChild(row);

            if(row.className !== bgClass) row.className = bgClass;

            const nameCell = row.querySelector('.name-cell');
            if(nameCell && nameCell.innerText !== p.name) nameCell.innerText = p.name;

            const idCell = row.querySelector('.id-cell');
            if(idCell && idCell.innerText !== p.studentId) idCell.innerText = p.studentId;

            const ansCell = row.querySelector('.ans-cell');
            if(ansCell && ansCell.innerHTML !== ansDisplay) ansCell.innerHTML = ansDisplay;

            const statCell = row.querySelector('.status-cell');
            if(statCell && statCell.innerText !== statusText) {
                statCell.innerText = statusText;
                statCell.className = `p-2 border-b font-bold status-cell ${statusClass}`;
            }
        });

        existingRows.forEach(row => row.remove());
        list.appendChild(newRowsFragment);

        const statsBar = document.getElementById('adm-stats-bar');
        if(statsBar) {
            let statsHtml = stats.map((count, i) => {
                const pct = totalAnswers > 0 ? Math.round((count/totalAnswers)*100) : 0;
                return `
                    <div class="bg-gray-200 rounded p-1 relative overflow-hidden">
                        <div class="absolute inset-0 bg-blue-100 smooth-width" style="width: ${pct}%; z-index:0;"></div>
                        <div class="relative z-10">
                            <span class="font-bold block text-xs">گزینه ${i+1}</span>
                            <span class="text-blue-800 font-bold">${count}</span>
                        </div>
                    </div>`;
            }).join('');
            statsHtml += `<div class="col-span-4 mt-1 bg-blue-50 border border-blue-200 rounded p-1 text-center"><span class="font-bold text-blue-800">مجموع آرا: ${totalAnswers}</span></div>`;
            if(statsBar.innerHTML !== statsHtml) statsBar.innerHTML = statsHtml;
        }

        const endBtn = document.getElementById('btn-end-q');
        if(endBtn) {
            if(data.gameState.phase === 'QUESTION') endBtn.classList.remove('hidden');
            else endBtn.classList.add('hidden');
        }

        if(allQuestions.length === 0 && data.allQuestions) {
            allQuestions = data.allQuestions;
            const sel = document.getElementById('adm-q-select');
            if(sel) {
                allQuestions.forEach((q, i) => {
                    const opt = document.createElement('option');
                    opt.value = i; opt.text = `سوال ${i+1}: ${q.text.substring(0,20)}...`; sel.appendChild(opt);
                });
                sel.onchange = updatePreview;
                updatePreview();
            }
        } else if (allQuestions.length > 0) {
            updatePreview();
        }
    });

    function updatePreview() {
        const idx = document.getElementById('adm-q-select').value;
        if (idx === "") return;
        const q = allQuestions[idx];

        const prevText = document.getElementById('adm-prev-text');
        if(prevText.innerText !== q.text) prevText.innerText = q.text;

        const stats = savedQuestionStats[idx];
        let total = 0;
        if (stats) total = stats.reduce((a,b) => a+b, 0);

        let optsHtml = q.options.map((o,i) => {
            let bgStyle = '';
            let statText = '';
            if (stats) {
                const count = stats[i];
                const pct = total > 0 ? Math.round((count/total)*100) : 0;
                const color = (i === q.correctIndex) ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                bgStyle = `background: linear-gradient(to left, ${color} ${pct}%, transparent ${pct}%);`;
                statText = `<span class="float-left font-bold text-xs bg-gray-100 px-1 rounded ml-2">${count} رای (${pct}%)</span>`;
            }
            const borderClass = (i === q.correctIndex) ? 'border-green-500 bg-green-50' : 'border-gray-200';
            return `
                <div class="p-2 border rounded mb-1 relative overflow-hidden ${borderClass}" style="${bgStyle}">
                    <span class="font-bold">${i+1}.</span> ${o} ${statText}
                </div>`;
        }).join('');

        if (stats) {
            optsHtml += `<div class="mt-2 text-center text-xs font-bold text-gray-500 border-t pt-2">مجموع کل آرا ثبت شده برای این سوال: ${total}</div>`;
        }

        const prevOpts = document.getElementById('adm-prev-opts');
        if(prevOpts.innerHTML !== optsHtml) prevOpts.innerHTML = optsHtml;
    }

    function toggleReviveMenu(e) { e.stopPropagation(); document.getElementById('revive-dropdown').classList.toggle('hidden'); }
    function closeDropdowns(e) { if(!e.target.closest('#btn-revive-menu')) document.getElementById('revive-dropdown').classList.add('hidden'); }

    function adminStartSelected() {
        const duration = document.getElementById('adm-time-select').value;
        runSmoothTimer(parseInt(duration));
        socket.emit('admin_command', {
            action: 'START_SPECIFIC',
            index: parseInt(document.getElementById('adm-q-select').value),
            duration: parseInt(duration)
        });
    }

    function togglePresenterList() { socket.emit('admin_command', { action: 'TOGGLE_PRESENTER_VIEW', mode: currentPresenterMode === 'GAME' ? 'ALIVE_LIST' : 'GAME' }); }
    function kick(id) { if(confirm('حذف؟')) socket.emit('admin_command', { action: 'KICK_PLAYER', studentId: id }); }
    function reviveOne(id) { if(confirm('ریوایو؟')) socket.emit('admin_command', { action: 'REVIVE_PLAYER', studentId: id }); }
    function reviveAll() { if(confirm('ریوایو همه؟')) socket.emit('admin_command', { action: 'REVIVE_ALL' }); }
    function reviveRound() { if(confirm('ریوایو حذف شدگان اخیر؟')) socket.emit('admin_command', { action: 'REVIVE_ROUND' }); }
    function resetEverything() { if(confirm('Reset all?')) socket.emit('admin_command', { action: 'RESET_ALL' }); }
</script>
</body>
</html>